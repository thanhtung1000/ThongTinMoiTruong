<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>App 2 - Thống kê dữ liệu môi trường</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    .card { max-width: 1000px; margin: auto; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
  </style>
</head>
<body>
  <div class="container py-5">
    <div class="card p-4">
      <h3 class="text-center mb-4">📋 Dữ liệu môi trường</h3>

      <form class="row g-3 mb-4" id="filterForm">
        <div class="col-md-4">
          <label class="form-label">Tên môi trường</label>
          <input type="text" id="stationName" class="form-control" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">Từ ngày</label>
          <input type="date" id="fromDate" class="form-control" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">Đến ngày</label>
          <input type="date" id="toDate" class="form-control" required>
        </div>
        <div class="col-12 text-center">
          <button type="submit" class="btn btn-primary px-5">Lọc & Thống kê</button>
        </div>
        <div class="mb-3">
          <label class="form-label">🔍 Tìm kiếm theo tên môi trường</label>
          <input type="text" id="searchInput" class="form-control" placeholder="Nhập tên môi trường...">
        </div>
      </form>

      <div class="table-responsive">
        <table class="table table-bordered table-striped">
          <thead class="table-dark">
            <tr>
              <th>ID</th><th>Tên</th><th>Thời gian</th><th>Nhiệt độ</th><th>Độ ẩm</th><th>Gió</th><th>Áp suất</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>

      <div id="stats"></div>
    </div>
  </div>

  <script>
    let allData = [];

    async function loadAllData() {
      try {
        const res = await fetch("http://localhost:5000/data?station=all&from=2000-01-01T00:00:00&to=2100-12-31T23:59:59");
        const data = await res.json();
        allData = data;
        renderTable(data);
      } catch (error) {
        console.error("Lỗi khi tải dữ liệu:", error);
      }
    }

    function renderTable(dataArray) {
      const tableBody = document.getElementById("tableBody");
      tableBody.innerHTML = "";
      dataArray.forEach(d => {
        const time = new Date(d.Time);
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${d.ID || "-"}</td>
          <td>${d.Name}</td>
          <td>${time.toLocaleString()}</td>
          <td>${d.Temperature}</td>
          <td>${d.Humidity}</td>
          <td>${d.Wind}</td>
          <td>${d.Pressure}</td>
        `;
        tableBody.appendChild(row);
      });
    }

    document.getElementById("searchInput").addEventListener("input", function () {
      const keyword = this.value.trim().toLowerCase();
      const filtered = allData.filter(d => d.Name.toLowerCase().includes(keyword));
      renderTable(filtered);
    });

    document.getElementById("filterForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("stationName").value.trim();
      const from = document.getElementById("fromDate").value;
      const to = document.getElementById("toDate").value;

      try {
        const res = await fetch(`http://localhost:5000/data?station=${name}&from=${from}T00:00:00&to=${to}T23:59:59`);
        const data = await res.json();
        renderTable(data);

        let tempSum = 0, humidityMax = 0;
        data.forEach(d => {
          tempSum += d.Temperature;
          humidityMax = Math.max(humidityMax, d.Humidity);
        });

        const stats = document.getElementById("stats");
        if (data.length > 0) {
          stats.innerHTML = `
            <div class="alert alert-info mt-4">
              📊 <strong>${name}</strong> từ <strong>${from}</strong> đến <strong>${to}</strong><br>
              Trung bình nhiệt độ: <strong>${(tempSum / data.length).toFixed(2)}°C</strong><br>
              Độ ẩm cao nhất: <strong>${humidityMax}%</strong><br>
              Số bản ghi: <strong>${data.length}</strong>
            </div>
          `;
        } else {
          stats.innerHTML = `<div class="alert alert-warning mt-4">Không có dữ liệu phù hợp.</div>`;
        }
      } catch (error) {
        console.error("Lỗi khi lọc dữ liệu:", error);
      }
    });

    window.addEventListener("DOMContentLoaded", loadAllData);
  </script>
</body>
</html>
