<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>App 2 - Th·ªëng k√™ d·ªØ li·ªáu m√¥i tr∆∞·ªùng</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
    }
    .card {
      max-width: 1000px;
      margin: auto;
      box-shadow: 0 0 20px rgba(0,0,0,0.05);
    }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAJUdxF6YkhscmaRwy9E_yoq_-Q8caodI0",
      authDomain: "moitruongtunhien-5be69.firebaseapp.com",
      projectId: "moitruongtunhien-5be69",
      storageBucket: "moitruongtunhien-5be69.appspot.com",
      messagingSenderId: "242977010998",
      appId: "1:242977010998:web:d480cd7a3b1d75f1956f97",
      measurementId: "G-KLG09JLZ5P"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let allData = [];

    async function loadAllData() {
      const snapshot = await getDocs(collection(db, "environment"));
      const tableBody = document.getElementById("tableBody");
      tableBody.innerHTML = "";
      allData = [];

      snapshot.forEach((doc) => {
        const d = doc.data();
        d._time = new Date(d.Time);
        allData.push(d);

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${d.ID}</td>
          <td>${d.Name}</td>
          <td>${d._time.toLocaleString()}</td>
          <td>${d.Temperature}</td>
          <td>${d.Humidity}</td>
          <td>${d.Wind}</td>
          <td>${d.Pressure}</td>
        `;
        tableBody.appendChild(row);
      });
    }

    async function filterData(e) {
      e.preventDefault();
      const name = document.getElementById("stationName").value.trim().toLowerCase();
      const fromDate = new Date(document.getElementById("fromDate").value);
      const toDate = new Date(document.getElementById("toDate").value);
      toDate.setHours(23, 59, 59, 999);

      const tableBody = document.getElementById("tableBody");
      tableBody.innerHTML = "";

      let tempSum = 0, humidityMax = 0, count = 0;

      allData.forEach((d) => {
        if (
          d.Name.toLowerCase() === name &&
          d._time >= fromDate && d._time <= toDate
        ) {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${d.ID}</td>
            <td>${d.Name}</td>
            <td>${d._time.toLocaleString()}</td>
            <td>${d.Temperature}</td>
            <td>${d.Humidity}</td>
            <td>${d.Wind}</td>
            <td>${d.Pressure}</td>
          `;
          tableBody.appendChild(row);

          tempSum += d.Temperature;
          humidityMax = Math.max(humidityMax, d.Humidity);
          count++;
        }
      });

      const stats = document.getElementById("stats");
      if (count > 0) {
        stats.innerHTML = `
          <div class="alert alert-info mt-4">
            üìä <strong>${name}</strong> t·ª´ <strong>${fromDate.toLocaleDateString()}</strong> ƒë·∫øn <strong>${toDate.toLocaleDateString()}</strong><br>
            Trung b√¨nh nhi·ªát ƒë·ªô: <strong>${(tempSum / count).toFixed(2)}¬∞C</strong><br>
            ƒê·ªô ·∫©m cao nh·∫•t: <strong>${humidityMax}%</strong><br>
            S·ªë b·∫£n ghi: <strong>${count}</strong>
          </div>
        `;
      } else {
        stats.innerHTML = `<div class="alert alert-warning mt-4">Kh√¥ng c√≥ d·ªØ li·ªáu ph√π h·ª£p.</div>`;
      }
    }

    window.filterData = filterData;
    window.addEventListener("DOMContentLoaded", loadAllData);
  </script>
</head>
<body>
  <div class="container py-5">
    <div class="card p-4">
      <h3 class="text-center mb-4">üìã D·ªØ li·ªáu m√¥i tr∆∞·ªùng</h3>

      <form class="row g-3 mb-4" onsubmit="filterData(event)">
        <div class="col-md-4">
          <label class="form-label">T√™n tr·∫°m</label>
          <input type="text" id="stationName" class="form-control" placeholder="V√≠ d·ª•: Station A" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">T·ª´ ng√†y</label>
          <input type="date" id="fromDate" class="form-control" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">ƒê·∫øn ng√†y</label>
          <input type="date" id="toDate" class="form-control" required>
        </div>
        <div class="col-12 text-center">
          <button type="submit" class="btn btn-primary px-5">L·ªçc & Th·ªëng k√™</button>
        </div>
      </form>

      <div class="table-responsive">
        <table class="table table-bordered table-striped">
          <thead class="table-dark">
            <tr>
              <th>ID</th><th>T√™n</th><th>Th·ªùi gian</th><th>Nhi·ªát ƒë·ªô</th><th>ƒê·ªô ·∫©m</th><th>Gi√≥</th><th>√Åp su·∫•t</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>

      <div id="stats"></div>
    </div>
  </div>
</body>
</html>
